{% comment %}
  Calculate Contrast Color Snippet
  Converts a hex color to RGB, calculates brightness, and returns appropriate contrast color (black or white)
  
  Usage: 
    {% capture computed_text_color %}{% render 'cc-calculate-contrast-color', hex_color: section.settings.background, fallback_color: '#000000' %}{% endcapture %}
    {% capture eyebrow_text_color %}{% render 'cc-calculate-contrast-color', hex_color: section.settings.eyebrowbackground, fallback_color: '#000000' %}{% endcapture %}
    {% capture cta_text_color %}{% render 'cc-calculate-contrast-color', hex_color: section.settings.cta_background, fallback_color: computed_text_color %}{% endcapture %}
  
  Parameters:
    - hex_color: The hex color to calculate contrast for (can be null/blank/transparent/rgba with alpha 0)
    - fallback_color: Optional fallback contrast color to return if hex_color is invalid (defaults to '#000000' if not provided)
  
  Returns:
    - Outputs either '#000000' (black) or '#ffffff' (white)
    - If hex_color is invalid (blank/null/transparent/rgba with alpha 0), returns fallback_color directly
  
  Note: hex_color should include the # symbol (e.g., '#FF5733' or '#ffffff')
  If hex_color is invalid, fallback_color is returned directly without calculation.
{% endcomment %}

{% liquid
  # Check if hex_color is invalid (blank, null, transparent, or rgba with alpha 0)
  assign hex_color_raw = hex_color | downcase | strip
  assign is_invalid = false
  
  if hex_color == blank or hex_color == null or hex_color_raw == '' or hex_color_raw == 'transparent'
    assign is_invalid = true
  elsif hex_color_raw contains 'rgba(0,0,0,0)' or hex_color_raw contains 'rgba(255,255,255,0)'
    assign is_invalid = true
  endif
  
  # If invalid, return fallback_color directly (or default to black)
  if is_invalid
    if fallback_color != blank and fallback_color != null
      assign contrast_color = fallback_color
    else
      # Default to black if no fallback provided
      assign contrast_color = '#000000'
    endif
  else
    # Use Shopify's built-in color_brightness filter (returns 0-255)
    # This is more reliable than manual hex parsing
    assign brightness = hex_color | color_brightness
    
    if brightness > 128
      assign contrast_color = '#000000'
    else
      assign contrast_color = '#ffffff'
    endif
  endif
%}
{{- contrast_color -}}
